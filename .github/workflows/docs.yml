# =============================================================================
# TaipanStack â€” Documentation Deploy
# =============================================================================
# Builds MkDocs Material documentation and deploys to gh-pages.
# CRITICAL: Uses keep_files to preserve existing htmlcov/ and dev/bench/.
# =============================================================================

name: Documentation

on:
    push:
        branches: [main]
        paths:
            - "docs/**"
            - "mkdocs.yml"
            - "src/**/*.py"
            - ".github/workflows/docs.yml"
    workflow_dispatch:

permissions:
    contents: write

jobs:
    deploy:
        name: Build & Deploy Docs
        runs-on: ubuntu-latest

        steps:
            - name: Check out code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v6
              with:
                  python-version: "3.12"

            - name: Install Poetry
              run: pipx install poetry

            - name: Configure Poetry
              run: poetry config virtualenvs.in-project true

            - name: Cache dependencies
              uses: actions/cache@v5
              with:
                  path: .venv
                  key: docs-${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
                  restore-keys: |
                      docs-${{ runner.os }}-poetry-

            - name: Install dependencies
              run: poetry install --with docs --sync

            - name: Build documentation
              run: poetry run mkdocs build

            - name: Deploy to GitHub Pages
              uses: peaceiris/actions-gh-pages@v4
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  publish_dir: ./site
                  publish_branch: gh-pages
                  # CRITICAL: Preserve existing benchmark results and coverage reports
                  keep_files: true
                  user_name: "github-actions[bot]"
                  user_email: "github-actions[bot]@users.noreply.github.com"
                  commit_message: "docs: deploy MkDocs for ${{ github.sha }}"
