name: Invario Pipeline

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

jobs:
    security-audit:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.12
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install Security Tools
              run: |
                  pip install bandit safety

            - name: Run Bandit (SAST)
              run: bandit -r src/invario -ll

            # Safety check might fail if deps have vulnerabilities, useful to know but maybe not block
            # - name: Run Safety Check
            #   run: safety check

    quality-check:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Poetry
              run: pipx install poetry

            - name: Set up Python 3.12
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "poetry"

            - name: Install Dependencies
              run: poetry install

            - name: Lint with Ruff
              run: poetry run ruff check src tests

            - name: Type Check with Mypy
              run: poetry run mypy src

    tests:
        runs-on: ubuntu-latest
        needs: [quality-check] # Run tests only if quality checks pass
        services:
            postgres:
                image: postgres:15-alpine
                env:
                    POSTGRES_DB: invario_test
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: password
                ports:
                    - 5432:5432
                # Set health check to wait until postgres has started
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - uses: actions/checkout@v4

            - name: Install Poetry
              run: pipx install poetry

            - name: Set up Python 3.12
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "poetry"

            - name: Install Dependencies
              run: poetry install

            - name: Run Tests
              env:
                  DATABASE_URL: postgresql+asyncpg://postgres:password@localhost:5432/invario_test
                  STORAGE_TYPE: postgres # Use real postgres for integration tests in CI
              run: poetry run pytest --cov=src --cov-fail-under=85

    build-image:
        runs-on: ubuntu-latest
        needs: [security-audit, tests]
        steps:
            - uses: actions/checkout@v4

            - name: Build Docker Image
              run: docker build . -t invario:latest
